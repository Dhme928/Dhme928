<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>رفيقة - تقويم الدورة الشهرية</title>
<link href="https://fonts.googleapis.com/css2?family=Rakkas&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #e75480;
    --secondary-color: #4a004b;
    --light-pink-bg: #fff0f5;
    --header-font: 'Rakkas', cursive;
    --body-font: 'Arial', sans-serif;
  }
  body {
    font-family: var(--body-font);
    background: var(--light-pink-bg);
    margin: 0;
    padding: 0;
    color: var(--secondary-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: var(--primary-color);
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-family: var(--header-font);
    position: sticky;
    top: 0;
    z-index: 1100;
  }
  .content {
    flex-grow: 1;
    padding: 20px 10px;
    overflow-y: auto;
  }
  .page { display: none; }
  .page.active { display: block; }

  /* Modal Styles (Onboarding & Day Click) */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  .modal-overlay.active {
      display: flex;
  }
  .modal-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    font-family: var(--body-font);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .modal-content h2, .modal-content h3 {
    font-family: var(--header-font);
    color: var(--primary-color);
    margin-top: 0;
  }
  .modal-content .form-group, .modal-content .day-actions {
    margin-bottom: 15px;
    text-align: right;
  }
   .modal-content .day-actions button {
       width: 100%;
       margin-bottom: 10px;
   }
  .modal-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--secondary-color);
  }
  .modal-content input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box;
  }
  .modal-content button, .action-button {
    width: 100%;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 20px;
    font-family: var(--header-font);
    font-size: 18px;
    cursor: pointer;
    margin-top: 10px;
  }
   .action-button.secondary {
       background-color: #777;
   }

  /* Calendar Specific Styles */
  .calendar {
    max-width: 350px; margin: 20px auto; background: white;
    border-radius: 12px; box-shadow: 0 4px 12px rgba(231, 84, 128, 0.3);
    padding: 15px;
  }
  .month {
    text-align: center; font-size: 22px; font-weight: bold;
    margin-bottom: 15px; font-family: var(--header-font);
  }
  .weekdays {
    display: grid; grid-template-columns: repeat(7, 1fr);
    text-align: center; font-weight: bold; color: #a8326a; direction: rtl;
  }
  .days {
    display: grid; grid-template-columns: repeat(7, 1fr);
    text-align: center; gap: 5px; direction: rtl;
  }
  .day {
    padding: 4px 0; border-radius: 50%; cursor: pointer; user-select: none;
    font-size: 14px; position: relative; display: flex; justify-content: center;
    align-items: center; height: 42px; width: 42px; box-sizing: border-box;
    flex-direction: column; transition: background-color 0.2s;
  }
   .day .day-number { font-size: 14px; line-height: 1; font-weight: bold;}
   .day .emoji { font-size: 12px; line-height: 1; margin-top: 2px; height: 12px;}
  .day:hover { background: #ffe0eb; }
  .day.period { background: #f8c9d7; color: #a13d63; }
  .day.ovulation { background: #e0ffe0; color: #3b873b; }
  .day.pre-period { background: #f0e6fa; color: #764b8e; }
  .day.safe-day { background: #fffaf0; }
  .day.today .day-number {
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      padding: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
  }
  .day.empty { background: transparent; cursor: default; }

  /* --- Styles for Trackers (Mood & Symptoms) --- */
  .tracker-container {
    max-width: 350px; margin: 15px auto; background: white;
    border-radius: 12px; box-shadow: 0 4px 12px rgba(231, 84, 128, 0.3);
    padding: 15px; text-align: center;
  }
  .tracker-container h3 {
    color: var(--primary-color); font-family: var(--header-font);
    font-size: 18px; margin-top: 0; margin-bottom: 15px;
  }
  .options-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    justify-items: center;
  }
  .tracker-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 12px;
    transition: transform 0.2s, background-color 0.2s;
    background-color: transparent;
    width: 100%;
    box-sizing: border-box;
  }
  .tracker-option:hover {
    background-color: #ffe0eb;
  }
  .tracker-option.selected {
    background-color: #ffc0cb;
    border: 2px solid var(--primary-color);
    transform: scale(1.05);
  }
  .tracker-emoji {
    font-size: 30px;
    line-height: 1;
  }
  .tracker-label {
    font-size: 12px;
    margin-top: 5px;
    color: #555;
    font-weight: bold;
  }
  .tracker-label.symptom {
    color: var(--primary-color);
  }


  .legend {
    max-width: 350px; margin: 15px auto; display: flex; flex-wrap: wrap;
    justify-content: center; font-size: 13px; gap: 10px;
  }
  .legend div { display: flex; align-items: center; gap: 6px; }
  .legend span {
      display: inline-block; width: 15px; height: 15px; border-radius: 50%;
  }

  .calendar-nav-actions {
    display: flex; justify-content: space-around; max-width: 350px;
    margin: 20px auto 10px; gap: 10px;
  }
  .calendar-nav-actions button {
    flex: 1; margin: 0; padding: 12px 10px;
    background: var(--primary-color); border: none; border-radius: 20px;
    color: white; font-weight: bold; font-size: 15px; cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-family: var(--header-font);
  }

  /* Navigation Bar Styles */
  nav.tab-bar {
    display: flex; justify-content: space-around;
    background: var(--primary-color); padding: 10px 0;
    position: sticky; bottom: 0; width: 100%;
    box-shadow: 0 -2px 4px rgba(0,0,0,0.1); z-index: 1000;
  }
  nav.tab-bar button {
    background: none; border: none; color: white;
    font-size: 12px; display: flex; flex-direction: column;
    align-items: center; gap: 2px; cursor: pointer;
    padding: 5px 0; flex: 1; margin: 0;
    font-family: var(--header-font);
  }
  nav.tab-bar button.active { font-weight: bold; color: #ffdae9; }
  nav.tab-bar button i { font-size: 22px; }

  /* Page Content Wrapper */
  .page-content-wrapper { max-width: 700px; margin: 0 auto; padding: 0 10px; }
  .page h2 {
    color: var(--primary-color); text-align: center;
    margin-bottom: 20px; font-family: var(--header-font);
  }
  .page p {
    text-align: justify; color: #666; line-height: 1.6;
    font-family: var(--body-font); margin-bottom: 1em;
  }

  /* Articles & Fatwas Section */
  .articles-container {
    display: flex; flex-wrap: wrap; justify-content: center;
    gap: 15px; margin-top: 20px;
  }
  .article-box {
    background: white; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(231, 84, 128, 0.2);
    padding: 15px; max-width: 320px; width: 100%;
    text-align: right; display: flex; flex-direction: column;
  }
  .article-box h3 {
    color: var(--primary-color); font-size: 18px; margin-top: 0; margin-bottom: 10px;
    font-family: var(--header-font); text-align: right;
  }
  .article-preview {
    font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px;
    font-family: var(--body-font); flex-grow: 1; text-align: justify;
  }
  .article-full-content {
    max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;
    text-align: justify; padding-top: 10px;
    border-top: 1px dashed #ffe0eb; margin-top: 10px;
  }
  .article-full-content.active { max-height: 1500px; transition: max-height 0.7s ease-in; }
  .toggle-article {
    display: block; text-align: left; color: #a8326a; text-decoration: none;
    font-weight: bold; font-size: 13px; background: none; border: none;
    padding: 0; cursor: pointer; margin-top: 10px; align-self: flex-start;
  }

  /* Search Input Styles */
  .search-wrapper {
      max-width: 400px;
      margin: 0 auto 20px;
      padding: 0 5px;
  }
  .search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ffdae9;
      border-radius: 20px;
      font-size: 14px;
      box-sizing: border-box;
      font-family: var(--body-font);
      box-shadow: 0 2px 6px rgba(231, 84, 128, 0.1);
  }
  .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(231, 84, 128, 0.2);
  }
  .search-input::placeholder {
      color: #aaa;
  }


  /* Settings and Statistics Page Styles */
  .settings-form, .stats-container {
    background: white; padding: 20px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(231, 84, 128, 0.3);
  }
  .data-management { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
  .data-management h3 { color: var(--secondary-color); font-family: var(--header-font); }
  .delete-button {
      background-color: #d9534f;
      border: none; padding: 12px; color: white;
      width: 100%; border-radius: 8px; cursor: pointer;
      font-family: var(--body-font); font-weight: bold; margin-top: 10px;
  }
    .full-reset-button { background-color: #c9302c; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .form-group input {
    width: 100%; padding: 10px; border: 1px solid #ddd;
    border-radius: 8px; box-sizing: border-box;
  }
  .save-btn {
    width: 100%; padding: 12px; background: var(--primary-color); color: white;
    border: none; border-radius: 20px; font-family: var(--header-font);
    font-size: 18px; cursor: pointer; margin-top: 10px;
  }
  .stats-item {
    background: var(--light-pink-bg); padding: 15px;
    border-radius: 10px; margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .stats-item .label { font-weight: bold; }
  .stats-item .value {
    font-family: var(--header-font); font-size: 20px;
    color: var(--primary-color);
  }
  .stats-note { font-size: 13px; color: #888; text-align: center; margin-top: 20px; }

  /* --- Styles for Notes page & Log --- */
  .notes-textarea {
    width: 100%;
    max-width: 500px;
    display: block;
    margin: 20px auto;
    padding: 10px;
    border: 1px solid #ffc0cb;
    border-radius: 8px;
    min-height: 120px;
    font-size: 16px;
    color: var(--secondary-color);
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    font-family: var(--body-font);
    box-sizing: border-box;
  }
  .notes-log-container {
      display: flex;
      flex-direction: column-reverse; /* To show newest notes on top */
      gap: 15px;
      margin-top: 25px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
  }
  .note-entry {
      background: #ffffff;
      border: 1px solid #ffdae9;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(231, 84, 128, 0.1);
  }
  .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #ffe0eb;
      font-size: 13px;
      color: #888;
  }
  .note-date {
      font-weight: bold;
  }
  .note-meta-right span {
      font-size: 20px;
      margin-left: 5px;
  }
  .note-text {
      font-size: 15px;
      color: var(--secondary-color);
      white-space: pre-wrap;
      line-height: 1.6;
      word-wrap: break-word;
  }

</style>
</head>
<body>

<div id="onboardingModal" class="modal-overlay">
  <div class="modal-content">
    <h2>💖 أهلاً بكِ في رفيقة</h2>
    <p>لنبدأ بتخصيص تجربتكِ. يرجى إدخال بعض المعلومات الأولية.</p>
    <form id="onboardingForm">
      <div class="form-group">
        <label for="onboardingCycleLength">كم متوسط عدد أيام دورتكِ الكاملة؟ (من بداية حيض لبداية الحيض التالي)</label>
        <input type="number" id="onboardingCycleLength" value="28" required>
      </div>
      <div class="form-group">
        <label for="onboardingPeriodLength">كم متوسط عدد أيام النزيف (الحيض)؟</label>
        <input type="number" id="onboardingPeriodLength" value="5" required>
      </div>
      <div class="form-group">
        <label for="onboardingLastPeriod">متى كان أول يوم في آخر دورة لكِ؟</label>
        <input type="date" id="onboardingLastPeriod" required>
      </div>
      <button type="submit">حفظ والبدء</button>
    </form>
  </div>
</div>

<div id="dayClickModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="dayClickModalTitle"></h3>
        <div class="day-actions">
            <button id="startPeriodBtnModal" class="action-button">🩸 بدء الدورة في هذا اليوم</button>
            <button id="endPeriodBtnModal" class="action-button">✅ إنهاء الدورة في هذا اليوم</button>
        </div>
        <button id="closeDayClickModalBtn" class="action-button secondary">إغلاق</button>
    </div>
</div>


<header id="appHeader">رفيقة 💕 - تقويم الدورة الشهرية</header>

<div class="content">
  <div id="menstrualCalendar" class="page active">
    <div class="calendar" aria-label="تقويم الدورة الشهرية">
      <div class="month" id="monthYear"></div>
      <div class="weekdays">
        <div>أحد</div><div>اثنين</div><div>ثلاثاء</div><div>أربعاء</div><div>خميس</div><div>جمعة</div><div>سبت</div>
      </div>
      <div class="days" id="daysGrid"></div>
    </div>
    <div class="legend">
      <div><span style="background: #f8c9d7;"></span> أيام الدورة</div>
      <div><span style="background: #e0ffe0;"></span> أيام التبويض</div>
      <div><span style="background: #f0e6fa;"></span> ما قبل الدورة</div>
      <div><span style="background: #fffaf0;"></span> أيام آمنة</div>
    </div>
    <div class="calendar-nav-actions">
        <button id="prevMonthBtn">الشهر السابق</button>
        <button id="nextMonthBtn">الشهر التالي</button>
    </div>

    <div class="tracker-container">
      <h3>كيف مزاجك اليوم؟</h3>
      <div class="options-grid" id="moodTracker">
        </div>
    </div>

    <div class="tracker-container">
        <h3>هل تشعرين بأي أعراض اليوم؟</h3>
        <div class="options-grid" id="symptomTracker">
          </div>
      </div>
  </div>

  <div id="religiousFatwas" class="page">
     <div class="page-content-wrapper">
      <h2>🧕 قسم فتاوى الطهارة والدورة</h2>
      <p style="text-align: center;">يحتوي هذا القسم على فتاوى شرعية مهمة تتعلق بأحكام الطهارة والدورة الشهرية، معتمدين على فتاوى سماحة الشيخ عبد العزيز بن باز رحمه الله.</p>
       <div class="search-wrapper">
         <input type="text" id="fatwaSearchInput" class="search-input" placeholder="🔎 ابحثي في عنوان الفتوى ومحتواها...">
       </div>
      <div class="articles-container" id="fatwasContainer">
        </div>
      <p style="text-align: center; margin-top: 20px; font-size: 13px;"> ملاحظة هامة: هذه الفتاوى مقتبسة من موقع سماحة الشيخ عبد العزيز بن باز رحمه الله (binbaz.org.sa) لغرض التوضيح والمعرفة العامة. للمسائل الشرعية الدقيقة، يرجى الرجوع إلى أهل العلم الثقات.</p>
    </div>
  </div>

  <div id="articles" class="page">
     <div class="page-content-wrapper">
        <h2>📚 مقالات ثقافية ودينية</h2>
        <p style="text-align: center;">مجموعة من المقالات الهادفة التي تتناول مواضيع تهم الفتاة المسلمة، لزيادة الوعي والمعرفة.</p>
        <div class="search-wrapper">
          <input type="text" id="articleSearchInput" class="search-input" placeholder="🔎 ابحثي في عنوان المقال ومحتواه...">
        </div>
        <div class="articles-container" id="articlesContainer">
            </div>
      </div>
  </div>

  <div id="statistics" class="page">
    <div class="page-content-wrapper">
      <h2>📊 إحصائيات دورتكِ</h2>
      <p style="text-align: center;">هنا ملخص لبيانات دوراتكِ المسجلة لمساعدتكِ على فهم طبيعة جسمكِ بشكل أفضل.</p>
      <div id="statsContainer" class="stats-container">
        </div>
      <div class="stats-note">
        ملاحظة: هذه الأرقام هي متوسطات محسوبة من الدورات التي قمتِ بتسجيلها في التطبيق. كلما زاد عدد الدورات المسجلة، كانت الإحصائيات أكثر دقة.
      </div>
    </div>
  </div>

  <div id="settings" class="page">
    <div class="page-content-wrapper">
        <h2>⚙️ الإعدادات</h2>
        <p style="text-align: center;">يمكنكِ تعديل تفضيلاتكِ هنا في أي وقت لتحديث توقعات التقويم.</p>
        <div class="settings-form">
            <div class="form-group">
                <label for="settingCycleLength">متوسط طول الدورة الكاملة (بالأيام)</label>
                <input type="number" id="settingCycleLength">
            </div>
            <div class="form-group">
                <label for="settingPeriodLength">متوسط مدة النزيف/الحيض (بالأيام)</label>
                <input type="number" id="settingPeriodLength">
            </div>
            <button id="saveSettingsBtn" class="save-btn">حفظ التغييرات</button>

            <div class="data-management">
                <h3>إدارة البيانات</h3>
                <p>إذا قمتِ بتسجيل دورة بالخطأ، يمكنك حذف آخر دورة تم إدخالها من هنا.</p>
                <button id="deleteLastCycleBtn" class="delete-button">حذف آخر دورة تم تسجيلها</button>
                <p style="margin-top: 20px;">للبدء من جديد، يمكنك حذف جميع بيانات التطبيق والعودة لشاشة البداية.</p>
                <button id="fullResetBtn" class="delete-button full-reset-button">إعادة تعيين التطبيق بالكامل</button>
            </div>
        </div>
    </div>
  </div>

  <div id="personalNotes" class="page">
    <div class="page-content-wrapper">
      <h2>💬 ملاحظاتي الشخصية</h2>
      <p style="text-align: center;">يمكنك استخدام هذه الواجهة لتدوين ملاحظاتك اليومية وحفظها في سجل دائم.</p>

      <div style="font-family: 'Rakkas', cursive; font-size: 20px; color: #e75480; background-color: #fff0f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
        🌷 إلى من ستكون رفيقة دربي، وزهرة عمري.. <strong>منى</strong> 💕<br>
        هذا التطبيق من قلب يحبك، اسمه "رفيقة" لأنه يشبهك.
      </div>

      <textarea id="notesInput" class="notes-textarea" placeholder="اكتبي ملاحظة جديدة هنا..."></textarea>
      <button id="saveNotesBtn" class="save-btn">حفظ الملاحظة في السجل</button>

      <div id="notesLogContainer" class="notes-log-container"></div>
    </div>
  </div>
</div>

<nav class="tab-bar">
  <button data-page="menstrualCalendar" class="active">
    <i class="icon">🩸</i>
    التقويم
  </button>
  <button data-page="statistics">
    <i class="icon">📊</i>
    إحصائيات
  </button>
  <button data-page="religiousFatwas">
    <i class="icon">🧕</i>
    فتاوى
  </button>
  <button data-page="articles">
    <i class="icon">📚</i>
    مقالات
  </button>
  <button data-page="settings">
    <i class="icon">⚙️</i>
    إعدادات
  </button>
  <button data-page="personalNotes">
    <i class="icon">💬</i>
    ملاحظاتي
  </button>
</nav>

<script>
// --- DATA: Moods & Symptoms are static ---
const moodsData = [
    { emoji: '😍', text: 'رائعة' },
    { emoji: '😊', text: 'سعيدة' },
    { emoji: '😌', text: 'هادئة' },
    { emoji: '😴', text: 'متعبة' },
    { emoji: '🤔', text: 'قلقة' },
    { emoji: '😠', text: 'غاضبة' }
];
const symptomsData = [
    { emoji: '🤕', text: 'تقلصات' },
    { emoji: '🤯', text: 'صداع' },
    { emoji: '😩', text: 'إرهاق' },
    { emoji: '🐡', text: 'انتفاخ' },
    { emoji: '🍓', text: 'حب شباب' },
    { emoji: '🦴', text: 'ألم ظهر' }
];

// --- Main App Logic ---
document.addEventListener('DOMContentLoaded', () => {

    // --- Element Variables ---
    const appHeader = document.getElementById('appHeader');
    const tabButtons = document.querySelectorAll('.tab-bar button');
    const pages = document.querySelectorAll('.page');
    const onboardingModal = document.getElementById('onboardingModal');
    const dayClickModal = document.getElementById('dayClickModal');
    const onboardingForm = document.getElementById('onboardingForm');
    const monthYearEl = document.getElementById('monthYear');
    const daysGrid = document.getElementById('daysGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const notesInput = document.getElementById('notesInput');
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    const notesLogContainer = document.getElementById('notesLogContainer');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const deleteLastCycleBtn = document.getElementById('deleteLastCycleBtn');
    const fullResetBtn = document.getElementById('fullResetBtn');
    const startPeriodBtnModal = document.getElementById('startPeriodBtnModal');
    const endPeriodBtnModal = document.getElementById('endPeriodBtnModal');
    const closeDayClickModalBtn = document.getElementById('closeDayClickModalBtn');
    const moodTrackerContainer = document.getElementById('moodTracker');
    const symptomTrackerContainer = document.getElementById('symptomTracker');

    let currentCalendarDate = new Date();
    let selectedDateForModal = null;
    
    // --- Page Switching Logic ---
    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        tabButtons.forEach(button => button.classList.toggle('active', button.dataset.page === pageId));
        const pageTitles = {
            menstrualCalendar: 'رفيقة 💕 - تقويم الدورة الشهرية',
            statistics: '📊 إحصائيات دورتكِ',
            religiousFatwas: '🧕 فتاوى الطهارة والدورة',
            articles: '📚 مقالات ثقافية ودينية',
            settings: '⚙️ الإعدادات',
            personalNotes: '💬 ملاحظاتي الشخصية'
        };
        appHeader.textContent = pageTitles[pageId] || 'رفيقة 💕';

        if (pageId === 'statistics') calculateAndDisplayStats();
        if (pageId === 'settings') loadSettingsToUI();
        if (pageId === 'personalNotes') renderNotesLog();
    }
    tabButtons.forEach(button => button.addEventListener('click', () => showPage(button.dataset.page)));

    // --- Onboarding Logic ---
    function checkOnboarding() {
        if (!localStorage.getItem('isSetupComplete')) {
            onboardingModal.classList.add('active');
        } else {
            initializeApp();
        }
    }
    onboardingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const cycleLength = document.getElementById('onboardingCycleLength').value;
        const periodLength = document.getElementById('onboardingPeriodLength').value;
        const lastPeriodDate = document.getElementById('onboardingLastPeriod').value;
        const userSettings = { cycleLength: parseInt(cycleLength), periodLength: parseInt(periodLength) };
        localStorage.setItem('userSettings', JSON.stringify(userSettings));
        if (lastPeriodDate) {
            const startDate = new Date(lastPeriodDate);
            startDate.setHours(0, 0, 0, 0);
            const cycle = { startDate: startDate.toISOString(), endDate: null };
            localStorage.setItem('allPeriodCycles', JSON.stringify([cycle]));
        }
        localStorage.setItem('isSetupComplete', 'true');
        onboardingModal.classList.remove('active');
        initializeApp();
    });

    // --- Initial App Start ---
    function initializeApp() {
        showPage('menstrualCalendar');
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        setupTrackers();
    }

    // --- Helper Functions ---
    function getUserSettings() { return JSON.parse(localStorage.getItem('userSettings')) || { cycleLength: 28, periodLength: 5 }; }

    function addToggleListeners() {
        const contentContainer = document.querySelector('.content');
        contentContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.toggle-article');
            if (button) {
                const fullContent = button.previousElementSibling;
                const isActive = fullContent.classList.toggle('active');
                if (button.textContent.includes("الفتوى")) {
                   button.textContent = isActive ? 'أقل «' : "المزيد من الفتوى »";
                } else {
                   button.textContent = isActive ? 'أقل «' : "اقرئي المزيد »";
                }
            }
        });
    }

    // ===================================================================
    // START: DATA FETCHING AND CONTENT MANAGEMENT (FATWAS & ARTICLES)
    // ===================================================================

    function setupContentPage(config) {
        const container = document.getElementById(config.containerId);
        const searchInput = document.getElementById(config.searchInputId);
        if (!container || !searchInput) return;

        let allItems = []; 

        async function fetchAndInitialize() {
            container.innerHTML = `<p style="text-align:center; width:100%;">${config.loadingMessage}</p>`;
            try {
                // Check if the URL is a placeholder
                if (config.sheetURL.includes('!!!')) {
                    throw new Error("Placeholder URL is not replaced.");
                }
                const response = await fetch(config.sheetURL);
                if (!response.ok) throw new Error('فشل استجابة الشبكة');
                
                const tsvText = await response.text();
                
                const rows = tsvText.replace(/\r/g, '').split('\n').slice(1);
                allItems = rows.map(row => {
                    const values = row.split('\t');
                    const entry = {};
                    config.headers.forEach((header, index) => {
                        entry[header.trim()] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    });
                    return entry;
                }).filter(item => item[config.headers[0]] && item[config.headers[0]].trim() !== '');
                
                displayItems(allItems);

            } catch (error) {
                console.error(`خطأ في جلب ${config.name}:`, error);
                container.innerHTML = `<p style="text-align:center; width:100%;">${config.errorMessage}</p>`;
            }
        }
        
        function displayItems(itemList) {
            if (!itemList || itemList.length === 0) {
                container.innerHTML = `<p style="text-align:center; width:100%;">${config.notFoundMessage}</p>`;
                return;
            }
            container.innerHTML = itemList.map(item => config.renderFunction(item)).join('');
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (!searchTerm) {
                displayItems(allItems);
                return;
            }
            const filteredItems = allItems.filter(item => 
                Object.values(item).some(value => 
                    value.toLowerCase().includes(searchTerm)
                )
            );
            displayItems(filteredItems);
        }

        searchInput.addEventListener('input', handleSearch);
        fetchAndInitialize();
    }

    // --- Configuration for Fatwas Page ---
    const fatwasConfig = {
        name: 'الفتاوى',
        sheetURL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2we69hAwhkzJDSmT2DkjzdjYIkzK0CeJ955LK-ccit52SRHkznH3VPSwd23kXHiHpV2Z-38KhSYbd/pub?output=tsv',
        containerId: 'fatwasContainer',
        searchInputId: 'fatwaSearchInput',
        headers: ['العنوان', 'السؤال', 'الجواب', 'المصدر'],
        loadingMessage: 'جاري تحميل الفتاوى...',
        notFoundMessage: 'لا توجد نتائج تطابق بحثك.',
        errorMessage: 'عفواً، حدث خطأ أثناء تحميل البيانات.',
        renderFunction: (item) => {
            const title = item['العنوان'] || 'بدون عنوان';
            const question = item['السؤال'] || '';
            const answer = item['الجواب'] || 'لا يوجد محتوى';
            const source = item['المصدر'] || '';
            const fullContentHTML = `<p><b>السؤال:</b> ${question}</p><p><b>الجواب:</b> ${answer}</p>`;
            const sourceLink = source ? `<p style="font-size:13px; text-align:left;"><a href="${source}" target="_blank">المصدر</a></p>` : '';
            return `
                <div class="article-box">
                    <h3>${title}</h3>
                    <p class="article-preview">${answer.substring(0, 90)}...</p>
                    <div class="article-full-content">${fullContentHTML}${sourceLink}</div>
                    <button class="toggle-article">المزيد من الفتوى »</button>
                </div>`;
        }
    };

    // --- Configuration for Articles Page ---
    const articlesConfig = {
        name: 'المقالات',
        sheetURL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfgjFBZdT_ehc2iE4bnBIWk5pKHdrN2M-ZzFFMgMRR-ndm3CETykaMAzWxndIaqVbeCeRFDprUcTky/pub?output=tsv',
        containerId: 'articlesContainer',
        searchInputId: 'articleSearchInput',
        headers: ['العنوان', 'المحتوى'],
        loadingMessage: 'جاري تحميل المقالات...',
        notFoundMessage: 'لا توجد نتائج تطابق بحثك.',
        errorMessage: 'عفواً، حدث خطأ أثناء تحميل البيانات.',
        renderFunction: (item) => {
            const title = item['العنوان'] || 'بدون عنوان';
            const content = item['المحتوى'] || 'لا يوجد محتوى';
            return `
                <div class="article-box">
                    <h3>${title}</h3>
                    <p class="article-preview">${content.substring(0, 100)}...</p>
                    <div class="article-full-content"><p>${content}</p></div>
                    <button class="toggle-article">اقرئي المزيد »</button>
                </div>`;
        }
    };

    // Initialize both content pages
    setupContentPage(fatwasConfig);
    setupContentPage(articlesConfig);
    addToggleListeners(); 

    // ===================================================================
    // END: DATA FETCHING AND CONTENT MANAGEMENT
    // ===================================================================


    // --- All other functions for Calendar, Settings, Notes, Trackers etc. ---

    function loadSettingsToUI() {
        const settings = getUserSettings();
        document.getElementById('settingCycleLength').value = settings.cycleLength;
        document.getElementById('settingPeriodLength').value = settings.periodLength;
    }

    saveSettingsBtn.addEventListener('click', () => {
        const cycleLength = document.getElementById('settingCycleLength').value;
        const periodLength = document.getElementById('settingPeriodLength').value;
        const newSettings = { cycleLength: parseInt(cycleLength), periodLength: parseInt(periodLength) };
        localStorage.setItem('userSettings', JSON.stringify(newSettings));
        alert('تم حفظ الإعدادات بنجاح!');
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    });

    deleteLastCycleBtn.addEventListener('click', () => {
        if (confirm('هل أنتِ متأكدة من رغبتك في حذف آخر دورة مسجلة؟ لا يمكن التراجع عن هذا الإجراء.')) {
            let cycles = JSON.parse(localStorage.getItem('allPeriodCycles') || '[]');
            if (cycles.length > 0) {
                cycles.pop();
                localStorage.setItem('allPeriodCycles', JSON.stringify(cycles));
                alert('تم حذف آخر دورة بنجاح.');
                generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            } else {
                alert('لا توجد دورات مسجلة لحذفها.');
            }
        }
    });

    fullResetBtn.addEventListener('click', () => {
        if (confirm('تحذير! سيؤدي هذا إلى حذف جميع بياناتكِ نهائياً (الدورات، الإعدادات، الملاحظات) والبدء من جديد. هل أنتِ متأكدة؟')) {
            localStorage.clear();
            alert('تم إعادة تعيين التطبيق.');
            location.reload();
        }
    });

    function startPeriod(date) {
        let cycles = JSON.parse(localStorage.getItem('allPeriodCycles') || '[]');
        const isPeriodActive = cycles.some(c => c.endDate === null);
        if (isPeriodActive) {
            alert('لا يمكن بدء دورة جديدة بينما توجد دورة أخرى نشطة لم تنتهِ بعد.');
            return;
        }
        cycles.push({ startDate: date.toISOString(), endDate: null });
        localStorage.setItem('allPeriodCycles', JSON.stringify(cycles));
        alert(`تم تسجيل بداية الدورة في ${date.toLocaleDateString('ar-EG')}`);
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        dayClickModal.classList.remove('active');
    }

    function endPeriod(date) {
        let cycles = JSON.parse(localStorage.getItem('allPeriodCycles') || '[]');
        const activeCycleIndex = cycles.findIndex(c => c.endDate === null);
        if (activeCycleIndex === -1) {
            alert('لا توجد دورة نشطة لتسجيل انتهائها. يرجى تسجيل بداية الدورة أولاً.');
            return;
        }
        const startDate = new Date(cycles[activeCycleIndex].startDate);
        if (date < startDate) {
            alert('تاريخ انتهاء الدورة لا يمكن أن يكون قبل تاريخ بدايتها.');
            return;
        }
        cycles[activeCycleIndex].endDate = date.toISOString();
        localStorage.setItem('allPeriodCycles', JSON.stringify(cycles));
        alert(`تم تسجيل نهاية الدورة في ${date.toLocaleDateString('ar-EG')}`);
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        dayClickModal.classList.remove('active');
    }

    function getDayStatusForDate(date) {
        const settings = getUserSettings();
        const cycles = JSON.parse(localStorage.getItem('allPeriodCycles') || '[]');
        cycles.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

        const currentDate = new Date(date);
        currentDate.setHours(0,0,0,0);

        let dayType = 'safe-day';
        let isLoggedPeriod = false;

        for(const cycle of cycles){
            const startDate = new Date(cycle.startDate);
            if (!cycle.endDate) {
                const estimatedEndDate = new Date(startDate.getTime() + (settings.periodLength - 1) * 86400000);
                 if(currentDate >= startDate && currentDate <= estimatedEndDate) {
                     isLoggedPeriod = true;
                     dayType = 'period';
                     break;
                 }
            } else {
                const endDate = new Date(cycle.endDate);
                if(currentDate >= startDate && currentDate <= endDate){
                    isLoggedPeriod = true;
                    dayType = 'period';
                    break;
                }
            }
        }

        if(!isLoggedPeriod && cycles.length > 0){
            const lastCycleStart = new Date(cycles[cycles.length - 1].startDate);
            let referenceDate = lastCycleStart;

            while (true) {
                let nextCycleStartDate = new Date(referenceDate.getTime() + settings.cycleLength * 86400000);
                if (currentDate < nextCycleStartDate) break;
                referenceDate = nextCycleStartDate;
            }

            let dayInCycle = Math.round((currentDate - referenceDate) / 86400000);
            if (dayInCycle >= 0 && dayInCycle < settings.periodLength) dayType = 'period';
            else if (dayInCycle >= settings.cycleLength - 16 && dayInCycle <= settings.cycleLength - 13) dayType = 'ovulation';
            else if (dayInCycle >= settings.cycleLength - 7 && dayInCycle < settings.cycleLength) dayType = 'pre-period';
            else dayType = 'safe-day';
        }

        let emoji = ' ';
        switch(dayType) {
            case 'period': emoji = '🩸'; break;
            case 'ovulation': emoji = '🌸'; break;
            case 'pre-period': emoji = '✨'; break;
            case 'safe-day': emoji = '☁️'; break;
        }
        return { dayType, emoji };
    }

    function generateCalendar(year, month) {
        daysGrid.innerHTML = '';
        const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
        monthYearEl.textContent = `${monthNames[month]} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let startDayOfWeek = firstDayOfMonth.getDay();

        for (let i = 0; i < startDayOfWeek; i++) {
            daysGrid.appendChild(document.createElement('div')).classList.add('day', 'empty');
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('day');
            const currentDate = new Date(year, month, day);
            currentDate.setHours(0,0,0,0);

            const today = new Date();
            today.setHours(0,0,0,0);
            if(currentDate.getTime() === today.getTime()){
                dayEl.classList.add('today');
            }

            const { dayType, emoji } = getDayStatusForDate(currentDate);

            dayEl.classList.add(dayType);
            dayEl.innerHTML = `<span class="day-number">${day}</span><span class="emoji">${emoji}</span>`;
            dayEl.dataset.date = currentDate.toISOString();
            dayEl.addEventListener('click', () => {
                if (dayEl.classList.contains('empty')) return;
                selectedDateForModal = new Date(dayEl.dataset.date);
                document.getElementById('dayClickModalTitle').textContent = `خيارات يوم: ${selectedDateForModal.toLocaleDateString('ar-EG')}`;
                dayClickModal.classList.add('active');
            });
            daysGrid.appendChild(dayEl);
        }
    }

    startPeriodBtnModal.addEventListener('click', () => startPeriod(selectedDateForModal));
    endPeriodBtnModal.addEventListener('click', () => endPeriod(selectedDateForModal));
    closeDayClickModalBtn.addEventListener('click', () => dayClickModal.classList.remove('active'));

    prevMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    });
    nextMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    });

    // --- NOTES LOG LOGIC ---
    function renderNotesLog() {
        const notes = JSON.parse(localStorage.getItem('savedNotesLog') || '[]');
        notesLogContainer.innerHTML = ''; // Clear previous entries
        notes.forEach(note => {
            const noteEl = document.createElement('div');
            noteEl.className = 'note-entry';

            const formattedDate = new Date(note.date).toLocaleDateString('ar-EG', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            noteEl.innerHTML = `
                <div class="note-header">
                    <span class="note-date">${formattedDate}</span>
                    <span class="note-meta-right">
                        <span>${note.dayStatusEmoji || ''}</span>
                        <span>${note.mood || ''}</span>
                    </span>
                </div>
                <p class="note-text">${note.text}</p>
            `;
            notesLogContainer.appendChild(noteEl);
        });
    }

    saveNotesBtn.addEventListener('click', () => {
        const noteText = notesInput.value.trim();
        if (!noteText) {
            alert('يرجى كتابة ملاحظة أولاً.');
            return;
        }

        const today = new Date();
        const todayKey = today.toISOString().split('T')[0];
        const dailyData = JSON.parse(localStorage.getItem('dailyData') || '{}');
        const todayData = dailyData[todayKey] || {};

        const dayStatus = getDayStatusForDate(today);

        const newNote = {
            text: noteText,
            date: today.toISOString(),
            mood: todayData.mood || '😶',
            dayStatusEmoji: dayStatus.emoji
        };

        const notes = JSON.parse(localStorage.getItem('savedNotesLog') || '[]');
        notes.push(newNote);
        localStorage.setItem('savedNotesLog', JSON.stringify(notes));

        notesInput.value = '';
        alert('تم حفظ الملاحظة في السجل بنجاح!');
        renderNotesLog();
    });

    function calculateAndDisplayStats() {
        const statsContainer = document.getElementById('statsContainer');
        const cycles = JSON.parse(localStorage.getItem('allPeriodCycles') || '[]').filter(c => c.endDate);
        if(cycles.length < 2) {
            statsContainer.innerHTML = "<p>لا توجد بيانات كافية لعرض الإحصائيات. قومي بتسجيل وإتمام دورتين على الأقل.</p>";
            return;
        }

        let totalPeriodLength = 0;
        let totalCycleLength = 0;

        for (let i = 0; i < cycles.length; i++) {
            const start = new Date(cycles[i].startDate);
            const end = new Date(cycles[i].endDate);
            totalPeriodLength += (end - start) / 86400000 + 1;

            if (i > 0) {
                const prevStart = new Date(cycles[i-1].startDate);
                totalCycleLength += (start - prevStart) / 86400000;
            }
        }

        const avgPeriod = Math.round(totalPeriodLength / cycles.length);
        const avgCycle = Math.round(totalCycleLength / (cycles.length - 1));
        
        const statsContent = document.getElementById('statsContainer');
        statsContent.innerHTML = `
            <div class="stats-item">
                <span class="label">💖 متوسط طول الدورة الكاملة</span>
                <span class="value">${avgCycle} يوم</span>
            </div>
            <div class="stats-item">
                <span class="label">🩸 متوسط مدة فترة الحيض</span>
                <span class="value">${avgPeriod} أيام</span>
            </div>
        `;
    }

    function setupTrackers() {
        moodTrackerContainer.innerHTML = '';
        symptomTrackerContainer.innerHTML = '';

        moodsData.forEach(mood => {
            const optionEl = document.createElement('div');
            optionEl.className = 'tracker-option mood-option';
            optionEl.dataset.mood = mood.emoji;
            optionEl.innerHTML = `<span class="tracker-emoji">${mood.emoji}</span><span class="tracker-label">${mood.text}</span>`;
            moodTrackerContainer.appendChild(optionEl);
        });

        symptomsData.forEach(symptom => {
            const optionEl = document.createElement('div');
            optionEl.className = 'tracker-option symptom-option';
            optionEl.dataset.symptom = symptom.text;
            optionEl.title = symptom.text;
            optionEl.innerHTML = `<span class="tracker-emoji">${symptom.emoji}</span><span class="tracker-label symptom">${symptom.text}</span>`;
            symptomTrackerContainer.appendChild(optionEl);
        });

        const todayKey = new Date().toISOString().split('T')[0];
        let dailyData = JSON.parse(localStorage.getItem('dailyData')) || {};

        function updateSelections() {
            const todayData = dailyData[todayKey] || {};
            document.querySelectorAll('.mood-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.mood === todayData.mood);
            });
            document.querySelectorAll('.symptom-option').forEach(opt => {
                const symptoms = todayData.symptoms || [];
                opt.classList.toggle('selected', symptoms.includes(opt.dataset.symptom));
            });
        }

        moodTrackerContainer.addEventListener('click', (e) => {
            const option = e.target.closest('.mood-option');
            if (!option) return;
            if (!dailyData[todayKey]) dailyData[todayKey] = {};
            if (dailyData[todayKey].mood === option.dataset.mood) {
                delete dailyData[todayKey].mood;
            } else {
                dailyData[todayKey].mood = option.dataset.mood;
            }
            localStorage.setItem('dailyData', JSON.stringify(dailyData));
            updateSelections();
        });

        symptomTrackerContainer.addEventListener('click', (e) => {
            const option = e.target.closest('.symptom-option');
            if (!option) return;
            if (!dailyData[todayKey]) dailyData[todayKey] = {symptoms: []};
            if (!dailyData[todayKey].symptoms) dailyData[todayKey].symptoms = [];
            const symptom = option.dataset.symptom;
            const symptomIndex = dailyData[todayKey].symptoms.indexOf(symptom);
            if (symptomIndex > -1) {
                dailyData[todayKey].symptoms.splice(symptomIndex, 1);
            } else {
                dailyData[todayKey].symptoms.push(symptom);
            }
            localStorage.setItem('dailyData', JSON.stringify(dailyData));
            updateSelections();
        });
        updateSelections();
    }
    
    // --- Initial App Load ---
    checkOnboarding();
});
</script>
</body>
</html>
